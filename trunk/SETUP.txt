#################################################
## Configurando base de dados PostgreSQL
#################################################

## Instalação
sudo apt-get install postgresql
sudo /etc/init.d/postgresql start

## Criação de usuário
sudo su - postgres
createuser -P mlpuser # Coloque NO para todas as opções que aparecerão e senha 'mlpuser'
createdb mlpdb

## Criação das tabelas
psql mlpdb -h localhost

CREATE TABLE Relation (
    RelationID SERIAL PRIMARY KEY, 
    Name VARCHAR(30) NOT NULL UNIQUE, 
    NAttributes INTEGER NOT NULL, 
    NInstances INTEGER NOT NULL
);

CREATE TABLE Attribute (
    RelationID INTEGER, 
    AttrIndex INTEGER,
    Name VARCHAR(30),
    Type SMALLINT NOT NULL, 
    NominalCard SMALLINT,
    CHECK (Type IN (1,2)),
    PRIMARY KEY (RelationID, AttrIndex),
    UNIQUE (RelationID, Name),
    FOREIGN KEY (RelationID) REFERENCES Relation (RelationID)
);

CREATE TABLE Nominal (
    RelationID INTEGER,
    AttrIndex INTEGER,
    Name VARCHAR(30),
    PRIMARY KEY (RelationID, AttrIndex, Name),
    FOREIGN KEY (RelationID, AttrIndex) REFERENCES Attribute (RelationID, AttrIndex)
);

CREATE TABLE Data (
    RelationID INTEGER,
    InstanceIndex INTEGER,
    AttrIndex INTEGER,
    NumericValue NUMERIC,
    NominalValue VARCHAR(30),
    PRIMARY KEY (RelationID, InstanceIndex, AttrIndex),
    FOREIGN KEY (RelationID, AttrIndex) REFERENCES Attribute (RelationID, AttrIndex)
);

CREATE TABLE MLP (
	MLPID SERIAL PRIMARY KEY,
	RelationID INTEGER NOT NULL,
	Name VARCHAR(30) NOT NULL UNIQUE,
	MaxTolerance NUMERIC NOT NULL,
	InitialLearningRate NUMERIC NOT NULL,
	MinLearningRate NUMERIC NOT NULL,
	MaxLearningRate NUMERIC NOT NULL,
	ActivationType SMALLINT NOT NULL,
	TrainingType SMALLINT NOT NULL,
	NLayers INTEGER NOT NULL,
	CHECK (ActivationType IN (1,2)),
	CHECK (TrainingType IN (1,2)),
	FOREIGN KEY (RelationID) REFERENCES Relation (RelationID)
);

CREATE TABLE Layer (
	MLPIP INTEGER,
	LayerIndex INTEGER,
	NInputs INTEGER NOT NULL,
	NNeurons INTEGER NOT NULL,
	PRIMARY KEY (MLPID, LayerIndex),
	FOREIGN KEY (MLPID) REFERENCES MLP (MLPID)
);

CREATE TABLE Neuron (
	MLPIP INTEGER,
	LayerIndex INTEGER,
	NeuronIndex INTEGER,
	InputIndex INTEGER,
	Weight NUMERIC NOT NULL,
	PRIMARY KEY (MLPID, LayerIndex, NeuronIndex, InputIndex),
	FOREIGN KEY (MLPID, LayerIndex) REFERENCES Layer (MLPID, LayerIndex)
);

## Doação de privilégios
GRANT SELECT, INSERT, UPDATE, DELETE ON Relation TO mlpuser;
GRANT SELECT, INSERT, UPDATE, DELETE ON Attribute TO mlpuser;
GRANT SELECT, INSERT, UPDATE, DELETE ON Nominal TO mlpuser;
GRANT SELECT, INSERT, UPDATE, DELETE ON Data TO mlpuser;
GRANT SELECT, UPDATE, USAGE ON relation_relationid_seq TO mlpuser;

